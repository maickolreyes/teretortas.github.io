<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teretortas y Más · Agenda (Admin)</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="container brand">
      <div class="logo"><img src="teretortas_circle.png" alt="Teretortas y Más"/></div>
      <div>
        <h1>Agenda (Admin)</h1>
        <nav class="note">
          <a href="index.html">Inicio</a>
          <a href="arma_tu_torta.html">Arma tu torta</a>
          <a href="agenda.html" class="active"><b>Agenda</b></a>
          <a href="inventario.html">Inventario</a>
        </nav>
        <div class="note">Cupos/slots y estado de órdenes (demo local).</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <label>Fecha: <input type="date" id="f" /></label>
      <button class="btn" id="add">Agregar orden demo</button>
    </div>

    <div style="overflow:auto; max-height:65vh">
      <table id="t">
        <thead>
          <tr>
            <th>Orden</th><th>Cliente</th><th>Fecha</th><th>Hora</th>
            <th>Producto</th><th>Estado</th><th>Notas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <span>© Teretortas y Más · Demo</span>
      <span class="links">
        <a href="https://wa.me/56911111111" target="_blank" rel="noopener">WhatsApp +56 9 1111 1111</a>
        <a href="https://instagram.com/teretortasymas" target="_blank" rel="noopener">Instagram Teretortas y Más</a>
        <a href="https://facebook.com/teretortasymas" target="_blank" rel="noopener">Facebook Teretortas y Más</a>
      </span>
    </div>
  </footer>

  <script>
(function(){
  const tb = document.querySelector('#t tbody');
  const f = document.getElementById('f');
  f.valueAsDate = new Date();

  // Claves de almacenamiento
  const KEY_S = 'ttm_agenda';    // la nueva (sessionStorage)
  const KEY_L = 'tt_agenda_v1';  // tu antigua (localStorage)

  // Helpers
  function readSessionList(k){ try{ return JSON.parse(sessionStorage.getItem(k) || '[]'); }catch{ return []; } }
  function readLocalList(k){ try{ return JSON.parse(localStorage.getItem(k) || '[]'); }catch{ return []; } }
  function money(n){ return (n||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}); }
  const SLOTS = ['10:00','12:00','15:00','17:00','19:00'];

  function minDaysForSize(size){
    if (size==='T12' || size==='T16') return 14;
    if (size==='T20' || size==='T24') return 21;
    return 28; // T30 u otras
  }
  
  function toISO(d){ return d.toISOString().slice(0,10); }
  
  function slotCountsForDate(arr, dateStr){
    const counts = Object.fromEntries(SLOTS.map(t => [t,0]));
    arr.filter(x => x.fecha===dateStr).forEach(x => { if (counts[x.hora]!=null) counts[x.hora]++; });
    return counts;
  }
  
  function firstSlotWithCapacity(counts, cap=2){
    return SLOTS.find(t => (counts[t]||0) < cap) || null;
  }
  
  function nextDateStr(dateStr){
    const d = new Date(dateStr); d.setDate(d.getDate()+1);
    return toISO(d);
  }


  // Cargar agenda desde SStorage (nuevo) o fallback a LStorage (viejo)
  function loadAgendaRaw(){
    const a = readSessionList(KEY_S);
    if (a && a.length) return a;
    return readLocalList(KEY_L);
  }

  // Normalizador: soporta ambas estructuras
  // NUEVA entrada (de Arma tu Torta): {id,date,time,status,customer,phone,sku,total}
  // ANTIGUA entrada (tu demo): {orden,cliente,fecha,hora,producto,estado,notas}
  function normalizeEntry(x){
    return {
      id:     x.id || x.orden || '',
      date:   x.date || x.fecha || '',
      time:   x.time || x.hora || '',
      status: x.status || x.estado || 'Programada',
      customer: x.customer || x.cliente || '',
      phone:  x.phone || '',
      sku:    x.sku || x.producto || '—',
      total:  typeof x.total === 'number' ? x.total : 0,
      notes:  x.notes || x.notas || ''
    };
  }

  function statusPill(st){
    const map = { 'Programada':'info', 'Confirmada':'info', 'En producción':'warn', 'Lista':'ok', 'Entregada':'ok', 'Cancelada':'warn' };
    return `<span class="pill ${map[st]||'info'}">${st}</span>`;
  }

  function render(){
    const raw = loadAgendaRaw();
    const data = raw.map(normalizeEntry).filter(r => !f.value || r.date === f.value);

    tb.innerHTML = data
      .sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time))
      .map(r => `
        <tr data-id="${r.id}">
          <td class="mono">${r.id || '—'}</td>
          <td>${r.customer || '—'}</td>
          <td>${r.date || '—'}</td>
          <td>${r.time || '—'}</td>
          <td class="mono">${r.sku}</td>
          <td class="right">${money(r.total)}</td>
          <td>${statusPill(r.status)}</td>
        </tr>
      `).join('');
  }

 document.getElementById('add').onclick = ()=>{
  const KEY_L = 'tt_agenda_v1';
  const all = JSON.parse(localStorage.getItem(KEY_L) || '[]');

  // 1) tamaño aleatorio y fecha mínima por tamaño
  const sizes = ['T12','T16','T20','T24','T30'];
  const size  = sizes[Math.floor(Math.random()*sizes.length)];
  const today = new Date(); today.setHours(0,0,0,0);
  const min = new Date(today.getTime() + minDaysForSize(size)*24*60*60*1000);
  let fechaMin = toISO(min);

  // 2) si el input tiene una fecha anterior a la mínima, corrígela al mínimo
  //    (y úsala como fecha deseada)
  if (!f.value || f.value < fechaMin) f.value = fechaMin;
  let fechaDeseada = f.value;

  // 3) asignar primer slot con capacidad (<2). Si el día está lleno, avanza de día
  let fecha = fechaDeseada;
  let counts = slotCountsForDate(all, fecha);
  let slot = firstSlotWithCapacity(counts, 2);
  let bumped = false;
  for (let i=0; i<31 && !slot; i++){
    fecha = nextDateStr(fecha);
    counts = slotCountsForDate(all, fecha);
    slot = firstSlotWithCapacity(counts, 2);
    bumped = true;
  }
  if (!slot){ // último recurso
    fecha = fechaDeseada;
    slot = SLOTS[0];
    bumped = true;
  }

  // 4) crear y guardar la orden demo en proceso
  const n = all.length + 1;
  all.push({
    orden: `TT-${String(n).padStart(4,'0')}`,
    cliente: 'Cliente Demo',
    fecha,                 // fecha final asignada (>= mínima por tamaño)
    hora: slot,            // con tope 2 por horario
    producto: `Torta personalizada ${size.replace('T','')}p`,
    estado: bumped ? 'En producción' : 'En producción', // puedes marcar 'Programada' si prefieres
    notas: `Auto (min por tamaño ${size}). ${bumped ? 'Reubicada por cupos.' : ''}`
  });
  localStorage.setItem(KEY_L, JSON.stringify(all));
  render();

  if (bumped){
    alert(`El día seleccionado estaba lleno. Se agendó automáticamente el ${fecha} a las ${slot}.`);
  }
};



  f.addEventListener('change', render);
  render();

  // Nav activo
  document.querySelectorAll('header nav a').forEach(a=>{
    const href = a.getAttribute('href') || '';
    if (location.pathname.endsWith(href)) a.classList.add('active');
  });
})();
</script>

</body>
</html>


