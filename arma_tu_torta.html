<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teretortas y Más · Arma tu torta</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px}
    @media (max-width:780px){.grid{grid-template-columns:1fr}}
    section.card{background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:14px;padding:16px;margin:12px 0}
    h1{font-size:28px;margin:6px 0 2px}
    h2{font-size:18px;margin:0 0 12px}
    label{font-weight:700;display:block;margin-bottom:6px}
    select, input[type="number"], input[type="text"], textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    .note{color:#6b7280;font-size:12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .tot{font-size:22px;font-weight:800}
    .btn{background:#111827;color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#f3f4f6;color:#111827}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    footer .links a{margin-left:10px}
  </style>
</head>
<body>
  <!-- HERO / MENÚ (fijo y bajo) -->
  <header class="hero" id="hero">
    <div class="container brand" style="width:100%;justify-content:space-between">
      <div class="brand" style="display:flex;gap:14px;align-items:center">
        <!-- Logo centrado: usa tu archivo existente -->
        <div class="logo"><img src="teretortas_circle.png" alt="Teretortas y Más"/></div>
        <!-- fila menu + botón a la derecha -->
        <div class="navbar-row">
          <h1>Teretortas y más</h1>
          <nav class="note">
            <a href="index.html" class="active"><b>Inicio</b></a>
            <a href="arma_tu_torta.html">Arma tu torta</a>
            <a href="agenda.html" class="admin-only">Agenda</a>
            <a href="inventario.html" class="admin-only">Inventario</a>
          </nav>
        
          <div class="auth-actions">
            <button id="btnLogin" class="btn secondary">Acceder</button>
            <button id="btnLogout" class="btn secondary" style="display:none">Salir</button>
          </div>
        </div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <!-- ============ 1) TAMAÑO, MARCO Y SABOR (REEMPLAZO) ============ -->
<section id="step1" class="card" style="margin-top:8px">
  <h2>1) Tamaño, marco y sabor</h2>

  <div class="note" style="margin:-6px 0 12px">
    Selecciona el tamaño (porciones/diámetro/capas), el <b>marco</b> (masa/base: sin azúcar, sin gluten, integral, etc.) y el sabor del bizcocho.
  </div>

  <div class="grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
    <!-- Tamaño -->
    <div>
      <label for="size">Tamaño</label>
      <select id="size" name="size">
        <option value="T12" data-porciones="12" data-diametro="18 cm" data-capas="2">12 porciones · Ø18 cm · 3 capas</option>
        <option value="T16" data-porciones="16" data-diametro="22 cm" data-capas="2">16 porciones · Ø22 cm · 3 capas</option>
        <option value="T20" data-porciones="20" data-diametro="24 cm" data-capas="3">20 porciones · Ø24 cm · 4 capas</option>
        <option value="T24" data-porciones="24" data-diametro="26 cm" data-capas="3">24 porciones · Ø26 cm · 4 capas</option>
        <option value="T30" data-porciones="30" data-diametro="30 cm" data-capas="3">30 porciones · Ø30 cm · 4 capas</option>
      </select>
      <p class="note" id="sizeMeta" style="margin:.35rem 0 0"></p>
    </div>

    <!-- Marco / Base dietaria -->
    <div>
      <label for="base">Marco (masa/base)</label>
      <select id="base" name="base">
        <option value="TRD" data-delta="0">Tradicional</option>
        <option value="SAZ" data-delta="1500">Sin azúcar (+$1.500)</option>
        <option value="SGL" data-delta="2000">Sin gluten (+$2.000)</option>
        <option value="INT" data-delta="1000">Integral (+$1.000)</option>
        <option value="ISG" data-delta="2500">Integral sin gluten (+$2.500)</option>
        <option value="VEG" data-delta="1500">Vegano (+$1.500)</option>
        <option value="VGS" data-delta="3000">Vegano sin gluten (+$3.000)</option>
      </select>
      <p class="note" style="margin:.35rem 0 0">El <b>marco</b> define la masa/base y restricciones dietarias.</p>
    </div>

    <!-- Sabor bizcocho -->
    <div>
      <label for="flavor">Sabor del bizcocho</label>
      <select id="flavor" name="flavor">
        <option value="VAN" data-delta="0">Vainilla</option>
        <option value="CHO" data-delta="1500">Chocolate (+$1.500)</option>
        <option value="RED" data-delta="2500">Red Velvet (+$2.500)</option>
        <option value="ZAN" data-delta="1500">Zanahoria (+$1.500)</option>
        <option value="LIM" data-delta="1000">Limón (+$1.000)</option>
      </select>
      <p class="note" style="margin:.35rem 0 0">Este ajuste se suma al precio del tamaño y del marco.</p>
    </div>
  </div>

  <!-- Resumen dinámico -->
  <div class="card" style="margin-top:14px;background:#fcfcfd">
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between">
      <div>
        <div class="note">SKU preliminar</div>
        <div id="skuPreview" class="mono" style="font-weight:700">–</div>
      </div>
      <div>
        <div class="note">Precio base estimado</div>
        <div id="pricePreview" style="font-size:1.25rem;font-weight:800">$0</div>
      </div>
    </div>
  </div>
</section>

    <!-- ============ 2) RELLENOS Y COBERTURA ============ -->
<section id="step2" class="card" style="margin-top:16px">
  <h2>2) Rellenos y coberturas</h2>
  <p class="note" style="margin:-6px 0 12px">
    Selecciona hasta <b>dos rellenos</b> y una <b>cobertura</b>. Mostramos opciones compatibles con tu marco del paso 1.
  </p>

  <div class="grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
    <!-- Relleno 1 -->
    <div>
      <label for="fill1">Relleno 1</label>
      <select id="fill1" name="fill1">
        <!-- opciones se cargan por JS -->
      </select>
      <p id="fill1Meta" class="note" style="margin:.35rem 0 0"></p>
    </div>

    <!-- Relleno 2 (opcional) -->
    <div>
      <label for="fill2">Relleno 2 (opcional)</label>
      <select id="fill2" name="fill2">
        <option value="">— Sin segundo relleno —</option>
      </select>
      <p id="fill2Meta" class="note" style="margin:.35rem 0 0"></p>
    </div>

    <!-- Cobertura -->
    <div>
      <label for="cover">Cobertura</label>
      <select id="cover" name="cover">
        <!-- opciones se cargan por JS -->
      </select>
      <p id="coverMeta" class="note" style="margin:.35rem 0 0"></p>
    </div>
  </div>

  <!-- Resumen -->
  <div class="card" style="margin-top:14px;background:#fcfcfd">
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between">
      <div>
        <div class="note">SKU (con rellenos y cobertura)</div>
        <div id="skuStep2" class="mono" style="font-weight:700">–</div>
      </div>
      <div>
        <div class="note">Total estimado (acum.)</div>
        <div id="priceStep2" style="font-size:1.25rem;font-weight:800">$0</div>
      </div>
    </div>
  </div>
</section>

    <!-- 3) Extras -->
<section class="card">
  <h2>3) Extras</h2>
  <div class="grid" id="extras-list">
    <!-- cada extra: data-name (para el resumen) y data-price en CLP -->
    <label>
      <input type="checkbox" class="extra" data-name="Velas" data-price="800">
      Velas <span class="price-tag"></span>
    </label>
    <label>
      <input type="checkbox" class="extra" data-name="Toppers" data-price="2500">
      Toppers <span class="price-tag"></span>
    </label>
    <label>
      <input type="checkbox" class="extra" data-name="Mini galletas" data-price="3000">
      Mini galletas <span class="price-tag"></span>
    </label>
    <label>
      <input type="checkbox" class="extra" data-name="Mensaje en chocolate" data-price="1200">
      Mensaje en chocolate <span class="price-tag"></span>
    </label>

    <!-- puedes seguir agregando aquí abajo -->
    <label>
      <input type="checkbox" class="extra" data-name="Flores comestibles" data-price="4500">
      Flores comestibles <span class="price-tag"></span>
    </label>
    <label>
      <input type="checkbox" class="extra" data-name="Caja regalo" data-price="2000">
      Caja regalo <span class="price-tag"></span>
    </label>
  </div>
  <p class="note">Los extras se agregan al total y aparecen como etiquetas.</p>
</section>


    <!-- 4) Contacto y mensaje -->
<section class="card">
  <h2>4) Contacto y mensaje</h2>
  <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <label for="contact_name">Nombre / quién retira *</label>
      <input type="text" id="contact_name" placeholder="Ej: Teresa Díaz" required>
      <p class="note">Nombre para identificar el pedido.</p>
    </div>
    <div>
      <label for="contact_whatsapp">WhatsApp *</label>
      <input type="text" id="contact_whatsapp" placeholder="+56 9 1234 5678" required>
      <p class="note">Usaremos este número para confirmar.</p>
    </div>
    <div>
      <label for="contact_email">Correo (opcional)</label>
      <input type="email" id="contact_email" placeholder="correo@ejemplo.cl">
    </div>
    <div>
      <label for="contact_date">Fecha tentativa (opcional)</label>
      <input type="date" id="contact_date">
    </div>
  </div>

  <label for="notas" style="margin-top:12px;display:block">Mensaje / especificaciones</label>
  <textarea id="notas" rows="3" placeholder="Texto del mensaje, colores, 'es para 12 personas', 'sin frutos secos', etc."></textarea>
  <p class="note">Estos datos se guardan junto con la configuración de la torta.</p>
</section>


    <!-- Resumen -->
    <section class="card">
      <h2>Resumen</h2>
      <div id="sku" class="note mono"></div>
      <ul id="summary" class="note"></ul>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="badges" id="badges"></div>
        <div class="tot" id="total">$0</div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnAdd">Añadir al carrito</button>
        <button class="btn secondary" id="btnNext">Ir a pagar</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <span>© Teretortas y Más · Demo</span>
      <span class="links">
        <a href="https://wa.me/56911111111" target="_blank" rel="noopener">WhatsApp +56 9 1111 1111</a>
        <a href="https://instagram.com/teretortasymas" target="_blank" rel="noopener">Instagram Teretortas y Más</a>
        <a href="https://facebook.com/teretortasymas" target="_blank" rel="noopener">Facebook Teretortas y Más</a>
      </span>
    </div>
  </footer>


  <script>
(function(){
  const KEY = 'ttm_auth'; // {role:'admin', user:'...'}
  const $btnLogin  = document.getElementById('btnLogin');
  const $btnLogout = document.getElementById('btnLogout');
  const $modal = document.getElementById('loginModal');
  const $u = document.getElementById('auth_user');
  const $p = document.getElementById('auth_pass');
  const $ok = document.getElementById('confirmLogin');
  const $cancel = document.getElementById('cancelLogin');

  function getAuth(){
    try{ return JSON.parse(sessionStorage.getItem(KEY) || 'null'); }catch{ return null; }
  }
  function setAuth(obj){
    sessionStorage.setItem(KEY, JSON.stringify(obj));
  }
  function clearAuth(){
    sessionStorage.removeItem(KEY);
  }

  function applyUI(){
    const auth = getAuth();
    const isAdmin = !!(auth && auth.role === 'admin');
    document.body.classList.toggle('show-admin', isAdmin);
    // botones
    $btnLogin.style.display  = isAdmin ? 'none' : 'inline-block';
    $btnLogout.style.display = isAdmin ? 'inline-block' : 'none';
  }

  function openModal(){
    $modal.classList.add('open');
    setTimeout(()=> $u.focus(), 50);
  }
  function closeModal(){
    $modal.classList.remove('open');
    $u.value=''; $p.value='';
  }

  // Reglas DEMO: cámbialas si quieres
  const DEMO_USER = 'admin';
  const DEMO_PASS = 'teretortas';

  // Eventos
  $btnLogin.addEventListener('click', openModal);
  $cancel.addEventListener('click', closeModal);
  $ok.addEventListener('click', () => {
    const user = ($u.value||'').trim();
    const pass = ($p.value||'').trim();
    if (user === DEMO_USER && pass === DEMO_PASS){
      setAuth({role:'admin', user});
      closeModal();
      applyUI();
    } else {
      alert('Usuario o contraseña inválidos.');
    }
  });

  $btnLogout.addEventListener('click', () => {
    clearAuth();
    applyUI();
  });

  // cerrar modal con fondo
  $modal.addEventListener('click', (e)=>{ if (e.target === $modal) closeModal(); });

  // init
  applyUI();
})();
</script>
   <script>
/* ====== Lógica básica del paso 1 (con MARCO) ====== */
(function(){
  // Precios base por tamaño (CLP)
  const SIZE_BASE = { T12:15990, T16:18990, T20:22990, T24:25990, T30:31990 };

  const $size     = document.getElementById('size');
  const $base     = document.getElementById('base');
  const $flavor   = document.getElementById('flavor');
  const $sizeMeta = document.getElementById('sizeMeta');
  const $price    = document.getElementById('pricePreview');
  const $sku      = document.getElementById('skuPreview');

  function money(n){ return n.toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}); }

  function updateMeta(){
    const opt = $size.selectedOptions[0];
    $sizeMeta.textContent = `${opt.dataset.porciones} porciones · ${opt.dataset.diametro} · ${opt.dataset.capas} capas`;
  }

  function updateSummary(){
    const sizeCode   = $size.value;
    const baseOpt    = $base.selectedOptions[0];
    const flavorOpt  = $flavor.selectedOptions[0];

    const baseDelta   = Number(baseOpt.dataset.delta || 0);
    const flavorDelta = Number(flavorOpt.dataset.delta || 0);

    const basePrice = SIZE_BASE[sizeCode] || 0;
    const total     = basePrice + baseDelta + flavorDelta;

    $price.textContent = money(total);

    // SKU: Txx-BASE-FLV
    const sku = `${sizeCode}-${baseOpt.value}-${flavorOpt.value}`;
    $sku.textContent = sku;

    sessionStorage.setItem('ttm_step1', JSON.stringify({
      size: sizeCode,
      sizeLabel: $size.selectedOptions[0].text,            // ← NUEVO
      sizeMeta: {
        porciones: $size.selectedOptions[0].dataset.porciones,
        diametro:  $size.selectedOptions[0].dataset.diametro,
        capas:     $size.selectedOptions[0].dataset.capas
      },
      base: baseOpt.value,
      baseLabel: baseOpt.text,
      flavor: flavorOpt.value,
      flavorLabel: flavorOpt.text,
      priceSize: basePrice,
      deltaBase: baseDelta,
      deltaFlavor: flavorDelta,
      priceTotal: total
    }));

    window.dispatchEvent(new CustomEvent('ttm:s1-change', {
      detail: JSON.parse(sessionStorage.getItem('ttm_step1'))
    }));
  }

  [$size,$base,$flavor].forEach(el => el.addEventListener('change', updateSummary));

  // init
  updateMeta();
  updateSummary();

  window.dispatchEvent(new CustomEvent('ttm:s1-change', {
    detail: JSON.parse(sessionStorage.getItem('ttm_step1'))
  }));

  // Responsivo simple para 2 columnas en pantallas medianas
  const grid = document.querySelector('#step1 .grid');
  const mq = window.matchMedia('(max-width: 980px)');
  function resp(){ grid.style.gridTemplateColumns = mq.matches ? '1fr' : '1fr 1fr 1fr'; }
  resp(); mq.addEventListener('change', resp);
})();
</script>

  <script>
/* ====== Paso 2: catálogo, filtros y precio (CORREGIDO) ====== */
(function(){
  // 1. estado actual del paso 1
  let s1 = JSON.parse(sessionStorage.getItem('ttm_step1') || '{}');

  // 2. mapa de restricciones
  const RESTR_FOR_BASE = {
    TRD: {v:false, s:false, g:false},
    SAZ: {v:false, s:true,  g:false},
    SGL: {v:false, s:false, g:true },
    INT: {v:false, s:false, g:false},
    ISG: {v:false, s:false, g:true },
    VEG: {v:true,  s:false, g:false},
    VGS: {v:true,  s:false, g:true }
  };

  // 3. catálogos
  const FILLS = [
    {code:'MUS', name:'Mousse de chocolate',    price:2500, v:true,  s:false, g:true },
    {code:'DLC', name:'Dulce de leche',         price:1500, v:true,  s:false, g:true },
    {code:'FRU', name:'Frutos rojos',           price:2200, v:true,  s:true,  g:true },
    {code:'CRE', name:'Crema pastelera',        price:1800, v:false, s:false, g:true },
    {code:'LIM', name:'Crema de limón',         price:1800, v:true,  s:true,  g:true },
    {code:'QCH', name:'Cheesecake (capas)',     price:2800, v:false, s:false, g:true },
    {code:'NUT', name:'Praliné de avellanas',   price:2600, v:true,  s:true,  g:true },
    {code:'ZAN', name:'Zanahoria especiada',    price:1900, v:true,  s:true,  g:true },
    {code:'MAN', name:'Manjar sin azúcar',      price:2200, v:true,  s:true,  g:true }
  ];
  const COVERS = [
    {code:'GAN', name:'Ganache chocolate',      price:2500, v:true,  s:false, g:true },
    {code:'BUT', name:'Buttercream clásico',    price:1800, v:false, s:false, g:true },
    {code:'CRM', name:'Crema chantilly',        price:1500, v:false, s:false, g:true },
    {code:'MER', name:'Merengue italiano',      price:1400, v:true,  s:true,  g:true },
    {code:'GLS', name:'Glaseado cítrico',       price:1200, v:true,  s:true,  g:true },
    {code:'VGN', name:'Buttercream vegano',     price:2200, v:true,  s:true,  g:true }
  ];

  // 4. refs
  const $fill1 = document.getElementById('fill1');
  const $fill2 = document.getElementById('fill2');
  const $cover = document.getElementById('cover');
  const $f1m   = document.getElementById('fill1Meta');
  const $f2m   = document.getElementById('fill2Meta');
  const $cvm   = document.getElementById('coverMeta');
  const $sku   = document.getElementById('skuStep2');
  const $price = document.getElementById('priceStep2');

  function money(n){ return (n||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}); }

  // ===== helper de compatibilidad (usa s1.base ACTUAL) =====
  function getNeed(){
    return RESTR_FOR_BASE[s1.base] || {v:false,s:false,g:false};
  }
  function compatible(item){
    const need = getNeed();
    if (need.v && !item.v) return false;
    if (need.s && !item.s) return false;
    if (need.g && !item.g) return false;
    return true;
  }

  // ===== render =====
  function renderOptions(){
    const prevF1 = $fill1.value;
    const prevF2 = $fill2.value;
    const prevCv = $cover.value;

    // relleno 1
    $fill1.innerHTML = '';
    FILLS.filter(compatible).forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.code;
      opt.textContent = `${f.name} (+${money(f.price)})`;
      opt.dataset.price = f.price;
      $fill1.appendChild(opt);
    });

    // relleno 2
    $fill2.innerHTML = '<option value="">— Sin segundo relleno —</option>';
    FILLS.filter(compatible).forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.code;
      opt.textContent = `${f.name} (+${money(f.price)})`;
      opt.dataset.price = f.price;
      $fill2.appendChild(opt);
    });

    // cobertura
    $cover.innerHTML = '';
    COVERS.filter(compatible).forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.code;
      opt.textContent = `${c.name} (+${money(c.price)})`;
      opt.dataset.price = c.price;
      $cover.appendChild(opt);
    });

    // restaurar si aún existen
    if ([...$fill1.options].some(o=>o.value===prevF1)) $fill1.value = prevF1;
    if ([...$fill2.options].some(o=>o.value===prevF2)) $fill2.value = prevF2;
    if ([...$cover.options].some(o=>o.value===prevCv)) $cover.value = prevCv;
  }

  function metaText(code, list){
    const it = list.find(x=>x.code===code);
    return it ? `${it.name} · ${money(it.price)}` : '—';
  }

  function updateSummary(){
    const f1 = $fill1.value;
    const f2 = $fill2.value || '';
    const cv = $cover.value;

    if (f1 && f2 && f1 === f2){
      $fill2.value = '';
      return updateSummary();
    }

    $f1m.textContent = metaText(f1, FILLS);
    $f2m.textContent = f2 ? metaText(f2, FILLS) : '—';
    $cvm.textContent = metaText(cv, COVERS);

    const p1 = Number($fill1.selectedOptions[0]?.dataset.price || 0);
    const p2 = Number($fill2.selectedOptions[0]?.dataset.price || 0);
    const pc = Number($cover.selectedOptions[0]?.dataset.price || 0);

    const baseTotal = Number(s1?.priceTotal || 0);
    const total     = baseTotal + p1 + p2 + pc;
    $price.textContent = money(total);

    const sku_s1 = `${s1?.size || 'T??'}-${s1?.base || '???'}-${s1?.flavor || '???'}`;
    const sku_s2 = `${f1 || 'NR'}${f2 || ''}-${cv || 'NC'}`;
    $sku.textContent = `${sku_s1}-${sku_s2}`;

    // guardar paso 2
    sessionStorage.setItem('ttm_step2', JSON.stringify({
      fill1: f1, fill1Label: metaText(f1, FILLS),          // ← NUEVO
      fill2: f2, fill2Label: f2 ? metaText(f2, FILLS) : '',// ← NUEVO
      cover: cv, coverLabel: metaText(cv, COVERS),         // ← NUEVO
      priceFill1: p1, priceFill2: p2, priceCover: pc,
      priceTotal: total
    }));

    // >>> emitir evento para el paso 3 <<<
    window.dispatchEvent(new CustomEvent('ttm:s2-change', {
      detail: JSON.parse(sessionStorage.getItem('ttm_step2'))
    }));
  }

  // ===== escuchar paso 1 en vivo =====
  window.addEventListener('ttm:s1-change', (ev) => {
    const prevBase = s1.base;
    s1 = ev.detail || s1;
    if (s1.base !== prevBase) {
      renderOptions();
    }
    updateSummary();
  });

  // init
  renderOptions();
  [$fill1,$fill2,$cover].forEach(el=>el.addEventListener('change', updateSummary));
  updateSummary();

  // responsivo
  const grid = document.querySelector('#step2 .grid');
  const mq2  = window.matchMedia('(max-width: 980px)');
  function resp(){ grid.style.gridTemplateColumns = mq2.matches ? '1fr' : '1fr 1fr 1fr'; }
  resp(); mq2.addEventListener('change', resp);
})();
</script>

  <script>
(function(){
  const $contactName  = document.getElementById('contact_name');
  const $contactWhats = document.getElementById('contact_whatsapp');
  const $contactEmail = document.getElementById('contact_email');
  const $contactDate  = document.getElementById('contact_date');
  const extrasEls = Array.from(document.querySelectorAll('.extra'));
  const $totalFinal = document.getElementById('total');
  const $badges     = document.getElementById('badges');
  const $summary    = document.getElementById('summary');
  const $skuFinal   = document.getElementById('sku');
  const $notas      = document.getElementById('notas');

  let s1 = JSON.parse(sessionStorage.getItem('ttm_step1') || '{}');
  let s2 = JSON.parse(sessionStorage.getItem('ttm_step2') || '{}');

  function money(n){
    return (n||0).toLocaleString('es-CL', {
      style:'currency',
      currency:'CLP',
      maximumFractionDigits:0
    });
  }

  // ===== Fecha mínima según tamaño =====
// T12/T16 => 2 semanas; T20/T24 => 3 semanas; resto => 4 semanas
function minDaysForSize(size){
  if (size === 'T12' || size === 'T16') return 14;
  if (size === 'T20' || size === 'T24') return 21;
  return 28; // T30 y superiores
}

function toISODate(d){ return d.toISOString().slice(0,10); }

    function applyMinDate(){
      // refrescar paso 1 por si cambió el tamaño
      s1 = JSON.parse(sessionStorage.getItem('ttm_step1') || '{}');
    
      // regla: T12/T16 = 14 días; T20/T24 = 21; resto = 28
      const days = (s1.size === 'T12' || s1.size === 'T16') ? 14
                  : (s1.size === 'T20' || s1.size === 'T24') ? 21
                  : 28;
    
      const base = new Date(); base.setHours(0,0,0,0);
      const min  = new Date(base.getTime() + days*24*60*60*1000);
      const iso  = min.toISOString().slice(0,10);
    
      if ($contactDate){
        // 1) fijar mínimo en el input (el calendario ya deshabilita anteriores)
        $contactDate.min = iso;
    
        // 2) AUTORRELLENAR: si está vacío o es menor, pone el mínimo
        if (!$contactDate.value || $contactDate.value < iso){
          $contactDate.value = iso;
        }
    
        // (opcional) etiqueta visual
        $contactDate.setAttribute('data-min-label', iso);
      }
    }



  // ⬇⬇ NUEVO: mostrar precio en el HTML al lado de cada extra
  extrasEls.forEach(el => {
    const price = Number(el.dataset.price || 0);
    const span = el.parentElement.querySelector('.price-tag');
    if (span) {
      span.textContent = price ? ` (${money(price)})` : '';
    }
  });

  function getExtrasSelected(){
    return extrasEls
      .filter(e => e.checked)
      .map(e => ({
        name: e.dataset.name,
        price: Number(e.dataset.price || 0)
      }));
  }

  function updateStep3(){
  // refrescar estados
    s1 = JSON.parse(sessionStorage.getItem('ttm_step1') || '{}');
    s2 = JSON.parse(sessionStorage.getItem('ttm_step2') || '{}');
  
    const extras = getExtrasSelected();
    const extrasTotal = extras.reduce((acc,x)=>acc + x.price, 0);
    const baseTotal = Number(s2?.priceTotal || s1?.priceTotal || 0);
    const finalTotal = baseTotal + extrasTotal;
  
    const lines = [];
  
    // ===== Detalle paso 1 =====
    lines.push(`Tamaño: ${s1.sizeLabel || s1.size || '—'}`);
    if (s1.sizeMeta){
      lines.push(`Porciones: ${s1.sizeMeta.porciones} · Diámetro: ${s1.sizeMeta.diametro} · Capas: ${s1.sizeMeta.capas}`);
    }
    lines.push(`Marco/base: ${s1.baseLabel || s1.base || '—'}`);
    lines.push(`Bizcocho: ${s1.flavorLabel || s1.flavor || '—'}`);
  
    // ===== Detalle paso 2 =====
    lines.push(`Relleno 1: ${s2.fill1Label || s2.fill1 || '—'}`);
    lines.push(`Relleno 2: ${s2.fill2 ? (s2.fill2Label || s2.fill2) : '—'}`);
    lines.push(`Cobertura: ${s2.coverLabel || s2.cover || '—'}`);
  
    // ===== Extras =====
    if (extras.length){
      lines.push('Extras: ' + extras.map(e => `${e.name} (+${money(e.price)})`).join(', '));
    }
  
    // ===== Contacto + Mensaje =====
    const notasTxt = $notas.value?.trim();
    if ($contactName.value.trim())  lines.push('Contacto: ' + $contactName.value.trim());
    if ($contactWhats.value.trim()) lines.push('WhatsApp: ' + $contactWhats.value.trim());
    if ($contactEmail.value.trim()) lines.push('Correo: ' + $contactEmail.value.trim());
    if ($contactDate.value)         lines.push('Fecha tentativa: ' + $contactDate.value);
    if (notasTxt)                   lines.push('Mensaje: ' + notasTxt);
  
    // pintar resumen
    $summary.innerHTML = lines.map(l => `<li>${l}</li>`).join('');
  
    // badges dietarios + extras
    const badges = [];
    if (s1.base === 'SAZ') badges.push('Sin azúcar');
    if (['SGL','ISG','VGS'].includes(s1.base)) badges.push('Sin gluten');
    if (['VEG','VGS'].includes(s1.base)) badges.push('Vegano');
    extras.forEach(e => badges.push(e.name));
    $badges.innerHTML = badges.map(b => `<span class="pill">${b}</span>`).join('');
  
    // total final
    $totalFinal.textContent = money(finalTotal);
  
    // SKU final
    const skuStep2 = (s1.size || 'T??') + '-' + (s1.base || '???') + '-' + (s1.flavor || '???')
                   + '-' + (s2.fill1 || 'NR') + (s2.fill2 || '') + '-' + (s2.cover || 'NC');
    const skuExtras = extras.length ? '-EX' + extras.length : '';
    $skuFinal.textContent = 'SKU: ' + skuStep2 + skuExtras;
  
    // guardar paso 3
    sessionStorage.setItem('ttm_step3', JSON.stringify({
      extras,
      notas: notasTxt,
      contact: {
        name:  $contactName.value.trim(),
        whatsapp: $contactWhats.value.trim(),
        email: $contactEmail.value.trim(),
        date:  $contactDate.value
      },
      priceExtras: extrasTotal,
      priceTotal: finalTotal
    }));
  }


  window.addEventListener('ttm:s2-change', (ev) => {
    s2 = ev.detail || s2;
    updateStep3();
  });

  extrasEls.forEach(el => el.addEventListener('change', updateStep3));
  $notas.addEventListener('input', updateStep3);
  [$contactName, $contactWhats, $contactEmail, $contactDate].forEach(el=>{
    if (el) el.addEventListener('input', updateStep3);
  });


  // Helpers
  function readS(n){ return JSON.parse(sessionStorage.getItem(n) || '{}'); }
  function readList(n){ return JSON.parse(sessionStorage.getItem(n) || '[]'); }
  function writeList(n, arr){ sessionStorage.setItem(n, JSON.stringify(arr)); }
  function genId(){ return 'TT-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*1e4).toString(36); }


  // Horarios disponibles por defecto
  const DEFAULT_SLOTS = ['10:00','12:00','15:00','18:00'];

    // contar reservas por slot en una fecha
  function slotCountsForDate(dateStr){
    const agenda = readList('ttm_agenda');
    const counts = Object.fromEntries(DEFAULT_SLOTS.map(t => [t, 0]));
    agenda.filter(x => x.date === dateStr).forEach(x => {
      if (counts[x.time] != null) counts[x.time]++;
    });
    return counts;
  }
  
  // devuelve el primer slot con < 2 reservas; si ninguno, null
  function firstAvailableSlot(dateStr){
    const counts = slotCountsForDate(dateStr);
    for (const t of DEFAULT_SLOTS){
      if ((counts[t] || 0) < 2) return t;
    }
    return null;
  }
  
  // avanzar a día siguiente (YYYY-MM-DD -> YYYY-MM-DD)
  function nextDateStr(dateStr){
    const d = new Date(dateStr);
    d.setDate(d.getDate() + 1);
    const iso = d.toISOString().slice(0,10);
    return iso;
  }

 // Asignar slot con tope de 2 por horario; si día lleno, busca día siguiente
  function assignSlotOrNext(dateStr, maxLookaheadDays = 30){
    let date = dateStr;
    for (let i = 0; i <= maxLookaheadDays; i++){
      const slot = firstAvailableSlot(date);
      if (slot) return { date, time: slot, bumped: (i > 0) };
      date = nextDateStr(date);
    }
    // fallback extremo: si no encontró en 30 días, vuelve a la fecha original primer slot
    return { date: dateStr, time: DEFAULT_SLOTS[0], bumped: true };
  }

  function buildOrder(){
    const s1 = JSON.parse(sessionStorage.getItem('ttm_step1') || '{}');
    const s2 = JSON.parse(sessionStorage.getItem('ttm_step2') || '{}');
    const s3 = JSON.parse(sessionStorage.getItem('ttm_step3') || '{}');
    const total = s3.priceTotal || s2.priceTotal || s1.priceTotal || 0;
  
    return {
      id: genId(),
      createdAt: new Date().toISOString(),
      total,
      step1: s1, step2: s2, step3: s3,
      contact: s3.contact || {},
      notes: s3.notas || ''
    };
  }


  function saveOrder(order){
    const list = readList('ttm_orders');
    list.push(order);
    writeList('ttm_orders', list);
  }

  function scheduleOrder(order){
    const wantedDate = order?.contact?.date;
    const pick = assignSlotOrNext(wantedDate);
  
    const agenda = readList('ttm_agenda');
    const entry = {
      id: order.id,
      date: pick.date,
      time: pick.time,
      status: pick.bumped ? 'Programada (reubicada)' : 'Programada',
      customer: order?.contact?.name || 'Sin nombre',
      phone: order?.contact?.whatsapp || '',
      sku:  (order.step1.size || 'T??') + '-' + (order.step1.base || '???') + '-' + (order.step1.flavor || '???')
          + '-' + (order.step2.fill1 || 'NR') + (order.step2.fill2 || '') + '-' + (order.step2.cover || 'NC'),
      total: order.total
    };
  
    agenda.push(entry);
    writeList('ttm_agenda', agenda);
  
    // Aviso gentil si se reubicó al día siguiente
    if (pick.bumped) {
      alert(`El día ${wantedDate} no tenía cupos disponibles.\nSe agendó automáticamente el ${pick.date} a las ${pick.time}.`);
    }
    return entry;
  }

  const btnAdd  = document.getElementById('btnAdd');
  const btnNext = document.getElementById('btnNext');

  if (btnAdd){
    btnAdd.addEventListener('click', () => {
      const s1 = JSON.parse(sessionStorage.getItem('ttm_step1') || '{}');
      const s2 = JSON.parse(sessionStorage.getItem('ttm_step2') || '{}');
      const s3 = JSON.parse(sessionStorage.getItem('ttm_step3') || '{}');
  
      const errs = [];
      if (!s1.size)   errs.push('Falta seleccionar el tamaño.');
      if (!s1.base)   errs.push('Falta seleccionar el marco/base.');
      if (!s1.flavor) errs.push('Falta seleccionar el sabor.');
      if (!s2.cover)  errs.push('Falta seleccionar la cobertura.');
      if (!s3?.contact?.name)     errs.push('Falta el nombre de contacto.');
      if (!s3?.contact?.whatsapp) errs.push('Falta el WhatsApp de contacto.');
      if (!s3?.contact?.date)     errs.push('Falta la fecha tentativa.');
  
      if (errs.length){
        alert('No se puede guardar el pedido:\n- ' + errs.join('\n- '));
        return;
      }
  
      const order = buildOrder();
  
      // Agregar al carrito acumulativo
      const cart = readList('ttm_cart');
      cart.push(order);
      writeList('ttm_cart', cart);
  
      // (Opcional) historial de órdenes también
      const orders = readList('ttm_orders');
      orders.push(order);
      writeList('ttm_orders', orders);
  
      alert(`Añadido al carrito (items: ${cart.length}).`);
    });
  }


  if (btnNext){
    btnNext.addEventListener('click', () => {
      // Validamos/guardamos y además AGENDAMOS en el horario disponible
      const s1 = readS('ttm_step1');
      const s2 = readS('ttm_step2');
      const s3 = readS('ttm_step3');

      const errs = [];
      if (!s1.size)   errs.push('Falta seleccionar el tamaño.');
      if (!s1.base)   errs.push('Falta seleccionar el marco/base.');
      if (!s1.flavor) errs.push('Falta seleccionar el sabor.');
      if (!s2.cover)  errs.push('Falta seleccionar la cobertura.');
      if (!s3?.contact?.name)     errs.push('Falta el nombre de contacto.');
      if (!s3?.contact?.whatsapp) errs.push('Falta el WhatsApp de contacto.');
      if (!s3?.contact?.date)     errs.push('Falta la fecha tentativa (se autocompleta con el mínimo).');

      if (errs.length){
        alert('No se puede continuar:\n- ' + errs.join('\n- '));
        return;
      }

      const order = buildOrder();
      saveOrder(order);
      const appt = scheduleOrder(order);  // ← aquí se agrega a la agenda (fecha + primer horario libre)
      // Redirigir a agenda para visualizarlo
      window.location.href = 'carrito.html';
    });
  }
  $contactDate.addEventListener('change', () => {
  const min = $contactDate.min || '';
  if ($contactDate.value && min && $contactDate.value < min){
    $contactDate.value = min; // vuelve al mínimo
  }
});

    // cuando cambie tamaño/base/sabor en paso 1 → recalcular mínimo
    window.addEventListener('ttm:s1-change', () => {
      applyMinDate();
      updateStep3();
    });
    
    // init
    applyMinDate();
    updateStep3();
})();
</script>



  
  
</body>
</html>
















