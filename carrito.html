<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teretortas y Más · Carrito</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    section.card{background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:14px;padding:16px;margin:12px 0}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .note{color:#6b7280;font-size:12px}
    .totals{border-top:1px dashed #e5e7eb;margin-top:10px;padding-top:10px}
    .money{font-weight:800}
    .due{font-size:22px;font-weight:900}
    .methods{display:flex;gap:12px;flex-wrap:wrap}
    .paycard{border:1px solid #e5e7eb;border-radius:12px;padding:12px;flex:1;min-width:260px}
    .btn{background:#111827;color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#f3f4f6;color:#111827}
    .right{text-align:right}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #f1f5f9;font-size:14px}
    th{font-size:12px;letter-spacing:.04em;text-transform:uppercase;color:#64748b}
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="logo"><img src="teretortas_circle.png" alt="Teretortas y Más"/></div>
      <div>
        <h1>Carrito</h1>
        <nav class="note">
          <a href="index.html">Inicio</a>
          <a href="arma_tu_torta.html">Arma tu torta</a>
          <a href="agenda.html">Agenda</a>
          <a href="inventario.html">Inventario</a>
        </nav>
        <div class="note">Para confirmar tu pedido debes <b>abonar el 50%</b> o pagar el total.</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <!-- Detalle del pedido -->
        <div>
          <h2>Resumen del pedido</h2>
          <div id="orderHeader" class="note"></div>

          <table style="margin-top:10px">
            <thead>
              <tr><th>Concepto</th><th class="right">Monto</th></tr>
            </thead>
            <tbody id="lines"><!-- items --></tbody>
            <tfoot>
              <tr><td class="right"><b>Subtotal</b></td><td class="right money" id="subtotal">$0</td></tr>
              <tr><td class="right">Extras</td><td class="right money" id="extras">$0</td></tr>
              <tr><td class="right">Total</td><td class="right money" id="total">$0</td></tr>
            </tfoot>
          </table>

          <div class="note" id="notes" style="margin-top:8px"></div>
        </div>

        <!-- Pago -->
        <div>
          <h2>Selecciona cómo pagar</h2>
          <div class="methods">
            <label class="paycard">
              <input type="radio" name="pay" value="deposit" checked>
              <b>Abonar 50%</b>
              <div class="note">Abonas ahora y pagas el resto al retirar/entregar.</div>
              <div class="totals">
                <div>Monto a abonar ahora</div>
                <div class="due" id="dueDeposit">$0</div>
                <div class="note">Saldo pendiente: <span id="dueBalance">$0</span></div>
              </div>
            </label>

            <label class="paycard">
              <input type="radio" name="pay" value="full">
              <b>Pagar total</b>
              <div class="note">Pagas el total y listo.</div>
              <div class="totals">
                <div>Total a pagar</div>
                <div class="due" id="dueFull">$0</div>
              </div>
            </label>
          </div>

          <div class="note" style="margin-top:8px">
            Luego de pagar, tu pedido pasa a <b>Confirmada</b> en la Agenda.
          </div>

          <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
            <button id="btnPay" class="btn">Confirmar pago (demo)</button>
            <button id="btnBack" class="btn secondary">Volver a configurar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <span>© Teretortas y Más · Demo</span>
      <span class="links">
        <a href="https://wa.me/56911111111" target="_blank" rel="noopener">WhatsApp +56 9 1111 1111</a>
        <a href="https://instagram.com/teretortasymas" target="_blank" rel="noopener">Instagram Teretortas y Más</a>
        <a href="https://facebook.com/teretortasymas" target="_blank" rel="noopener">Facebook Teretortas y Más</a>
      </span>
    </div>
  </footer>

<script>
(function(){
  // ===== Helpers de almacenamiento y formato =====
  const read = (k, def) => { try{ return JSON.parse(sessionStorage.getItem(k) || def); }catch{ return JSON.parse(def); } };
  const readList = (k) => read(k, '[]');
  const writeList = (k, val) => sessionStorage.setItem(k, JSON.stringify(val));
  const money = (n)=> (n||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});

  // ===== Fuente de verdad: carrito =====
  function getCart(){
    const cart = readList('ttm_cart');
    if (cart.length) return cart;

    // Fallback si llegaron directo sin carrito (construye 1 ítem desde step1..3)
    const s1 = read('ttm_step1','{}');
    const s2 = read('ttm_step2','{}');
    const s3 = read('ttm_step3','{}');
    const total = s3.priceTotal || s2.priceTotal || s1.priceTotal || 0;
    if (!total) return [];
    return [{
      id: 'TT-' + Date.now().toString(36),
      createdAt: new Date().toISOString(),
      total,
      step1: s1, step2: s2, step3: s3,
      contact: s3.contact || {},
      notes: s3.notas || ''
    }];
  }

  // ===== Render principal =====
  function render(){
    const cart = getCart();
    const btnPay = document.getElementById('btnPay');

    if (!cart.length){
      document.getElementById('orderHeader').innerHTML = '<b>Carrito vacío</b>';
      const lines = document.getElementById('lines');
      lines.innerHTML = '<tr><td colspan="2" class="note">No hay productos en tu carrito.</td></tr>';
      document.getElementById('subtotal').textContent = money(0);
      document.getElementById('extras').textContent   = money(0);
      document.getElementById('total').textContent    = money(0);
      document.getElementById('dueDeposit').textContent = money(0);
      document.getElementById('dueFull').textContent    = money(0);
      document.getElementById('dueBalance').textContent = money(0);
      if (btnPay) btnPay.disabled = true;
      return;
    }
    if (btnPay) btnPay.disabled = false;

    // Encabezado resumido (cliente/fecha del 1º y listado de fechas)
    const c0 = cart[0].contact || {};
    document.getElementById('orderHeader').innerHTML = `
      <div><b>Items:</b> ${cart.length}</div>
      <div><b>Cliente:</b> ${c0.name || '—'} · <b>WhatsApp:</b> ${c0.whatsapp || '—'}</div>
      <div><b>Fecha(s) tentativa(s):</b> ${[...new Set(cart.map(o=>o.contact?.date||'—'))].join(', ')}</div>
    `;

    // Filas (una por item del carrito, con botón Eliminar)
    const lines = document.getElementById('lines');
    lines.innerHTML = '';

    let subtotal = 0, extras = 0, grand = 0;

    cart.forEach((o, idx) => {
      const s1 = o.step1||{}, s2 = o.step2||{}, s3 = o.step3||{};
      subtotal += (s1.priceTotal || 0);
      extras   += (s3.priceExtras || 0);
      grand    += (o.total || 0);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          #${idx+1} · ${s1.sizeLabel||s1.size||''} · ${s1.baseLabel||s1.base||''} · ${s1.flavorLabel||s1.flavor||''}
          · R1:${s2.fill1||'—'} ${s2.fill2?('· R2:'+s2.fill2):''} · Cob:${s2.cover||'—'}
          <div class="note mono">ID: ${o.id} · Fecha: ${o.contact?.date || '—'}</div>
          <button class="btn secondary btn-del" data-id="${o.id}" style="margin-top:6px;padding:6px 10px">Eliminar</button>
        </td>
        <td class="right">${money(o.total || 0)}</td>
      `;
      lines.appendChild(tr);
    });

    document.getElementById('subtotal').textContent = money(subtotal);
    document.getElementById('extras').textContent   = money(extras);
    document.getElementById('total').textContent    = money(grand);

    const due50 = Math.round(grand*0.5);
    document.getElementById('dueDeposit').textContent = money(due50);
    document.getElementById('dueFull').textContent    = money(grand);
    document.getElementById('dueBalance').textContent = money(grand - due50);

    // Notas combinadas
    const allNotes = cart.map(o=>o.notes).filter(Boolean);
    document.getElementById('notes').textContent = allNotes.length ? ('Notas: ' + allNotes.join(' | ')) : '';
  }

  // ===== Eliminar item del carrito + liberar cita en agenda =====
  function removeItem(id){
    // 1) quitar del carrito
    let cart = readList('ttm_cart').filter(o => o.id !== id);
    writeList('ttm_cart', cart);

    // 2) si ya estaba agendado, quitar la cita asociada
    const agenda = readList('ttm_agenda');
    const ai = agenda.findIndex(a => a.id === id);
    if (ai > -1){
      agenda.splice(ai, 1);
      writeList('ttm_agenda', agenda);
    }

    // 3) refrescar vista
    render();
  }

  // Delegación para clicks en "Eliminar"
  document.getElementById('lines').addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-del');
    if (!btn) return;
    const id = btn.dataset.id;
    if (confirm('¿Eliminar este ítem del carrito?')) removeItem(id);
  });

  // ===== Confirmar pago (carrito completo) =====
  function confirmPayment(){
    const method = document.querySelector('input[name="pay"]:checked')?.value || 'deposit';
    const cart = getCart();
    if (!cart.length){ alert('Carrito vacío.'); return; }

    const grand = cart.reduce((a,o)=>a+(o.total||0),0);
    const payNow = method === 'deposit' ? Math.round(grand*0.5) : grand;

    // Registrar pago (nivel carrito)
    const payments = readList('ttm_payments');
    payments.push({
      cartId: 'C-' + Date.now().toString(36),
      date: new Date().toISOString(),
      method: method === 'deposit' ? 'Abono 50%' : 'Pago total',
      amount: payNow,
      orderIds: cart.map(o=>o.id)
    });
    writeList('ttm_payments', payments);

    // Confirmar todas las citas de estos items (si existen)
    const agenda = readList('ttm_agenda');
    let touched = 0;
    cart.forEach(o=>{
      const idx = agenda.findIndex(a => a.id === o.id);
      if (idx > -1){ agenda[idx].status = 'Confirmada'; touched++; }
    });
    sessionStorage.setItem('ttm_agenda', JSON.stringify(agenda));

    // Guardar también en historial de órdenes
    const orders = readList('ttm_orders');
    cart.forEach(o=>{ if (!orders.find(x=>x.id===o.id)) orders.push(o); });
    writeList('ttm_orders', orders);

    alert(`Pago registrado (demo): ${method==='deposit'?'Abono 50%':'Total'} por ${money(payNow)}.\nÓrdenes confirmadas: ${touched}.`);
    // Vaciar carrito tras pagar
    sessionStorage.removeItem('ttm_cart');
    location.href = 'agenda.html';
  }

  // ===== Volver =====
  function back(){ history.back(); }

  // Init
  render();
  document.getElementById('btnPay').addEventListener('click', confirmPayment);
  document.getElementById('btnBack').addEventListener('click', back);
})();
</script>

</body>
</html>
